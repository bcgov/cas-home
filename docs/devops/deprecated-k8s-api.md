# How to manually fix a deprecated kubernetes API blocking deployment

If a release manifest contains a fully deprecated k8s API (ie: the release has not been updated in a long time & an API version got completely deprecated since) then the next deploy will fail with an error that looks like this:
`Error: UPGRADE FAILED: current release manifest contains removed kubernetes api(s) for this kubernetes version and it is therefore unable to build the kubernetes objects for performing the diff`

To fix this error and allow deploys, the last deploy manifest will need to be manually edited to change the deprecated API version to a recognized one. Here are the steps:

1. Get the latest secret containing the deployment manifest generated by helm:
   - `oc get secret -l owner=helm,status=deployed,name=<Release Name> --namespace <Namespace> | awk '{print $1}' | grep -v NAME`
2. Save the contents of the secret to a file
   - `oc get secret <Secret Name> -n <Namespace> -o yaml > release.yaml`
3. Make a backup in case you need it
   - `cp release.yaml release.bak`
4. Get the Base64 manifest data out of the release secret
   - `cat release.yaml | grep -oP '(?<=release: ).*' > release.data`
5. Edit the `release.data` file. There is likely a set of `{}` at the end of the file. Remove these so the file only contains valid base64.
6. Decode the double base64 data and save to a new file
   - `cat release.data | base64 -d | base64 -d | gzip -d > release.data.decoded`
7. Edit the `release.data.decoded` file to update the deprecated API version. The version and resource will have been in the error thrown during the deployment attempt (for example: If the error showed `no matches for kind "PodDisruptionBudget" in version "policy/v1beta1"`), then find any `v1beta1` versions of `PodDisruptionBudget` in the decoded yaml & change them to `v1`).
8. Re-encode the edited `release.data.decoded` file
   - `cat release.data.decoded | gzip | base64 | base64 > release.data.encoded`
9. Trim newlines from the encoded data file
   - `tr -d "\n" < release.data.encoded > release.data.encoded.final`
10. Save the contents of the final encoded data file to a variable
   - `releaseData=$(cat release.data.encoded.final)`
11. Replace the `release` object in `release.yaml` with the updated base64 data & save to a new file
   - `sed 's/^\(\s*release\s*:\s*\).*/\1'$releaseData'/' release.yaml > final.release.yaml`
12. Apply the `final.release.yaml` manifest
   - `oc apply -f final.release.yaml -n <Namespace>`


Once these steps are complete, the latest deployment manifest will not contain the deprecated API version and deployment should no longer be blocked by this error.
